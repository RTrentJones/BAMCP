# ============================================================================
# BAMCP Docker Compose
#
# Profiles:
#   dev   — Development: mounts source, runs tests, hot-reload friendly
#   beta  — Pre-release: SSE transport with debug logging, no auth
#   prod  — Production: SSE transport, OAuth enabled, locked-down
#
# Usage:
#   docker compose --profile dev run test    # Run unit+integration tests
#   docker compose --profile dev run e2e     # Run Playwright E2E tests
#   docker compose --profile beta up         # Run beta server on :8000
#   docker compose --profile prod up         # Run production server on :8000
# ============================================================================

services:
  # --------------------------------------------------------------------------
  # Development: test runner with source mounts
  # --------------------------------------------------------------------------
  test:
    build:
      context: .
      dockerfile: Dockerfile.dev
    profiles: ["dev"]
    volumes:
      - ./src:/app/src:ro
      - ./tests:/app/tests:ro
      - ./pyproject.toml:/app/pyproject.toml:ro
    command: >
      python -m pytest tests/ --ignore=tests/e2e
      -v --cov=bamcp --cov-report=term-missing
    environment:
      - BAMCP_REFERENCE=
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1

  e2e:
    build:
      context: .
      dockerfile: Dockerfile.dev
    profiles: ["dev"]
    volumes:
      - ./src:/app/src:ro
      - ./tests:/app/tests:ro
      - ./pyproject.toml:/app/pyproject.toml:ro
    command: >
      python -m pytest tests/e2e/ -v
    environment:
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1

  lint:
    build:
      context: .
      dockerfile: Dockerfile.dev
    profiles: ["dev"]
    volumes:
      - ./src:/app/src:ro
      - ./tests:/app/tests:ro
    command: >
      sh -c "ruff format --check src tests && ruff check src tests && mypy src"
    environment:
      - PYTHONDONTWRITEBYTECODE=1

  # --------------------------------------------------------------------------
  # Beta: SSE transport, no auth, verbose logging
  # --------------------------------------------------------------------------
  beta:
    build:
      context: .
      dockerfile: Dockerfile
    profiles: ["beta"]
    ports:
      - "8000:8000"
    volumes:
      - bamcp-data:/data
    environment:
      - BAMCP_REFERENCE=/data/reference.fa
      - BAMCP_MAX_READS=10000
      - BAMCP_DEFAULT_WINDOW=500
      - BAMCP_MIN_VAF=0.1
      - BAMCP_MIN_DEPTH=10
      - BAMCP_MIN_MAPQ=0
      - BAMCP_TRANSPORT=sse
      - BAMCP_HOST=0.0.0.0
      - BAMCP_PORT=8000
      - BAMCP_AUTH_ENABLED=
      - PYTHONUNBUFFERED=1
    restart: unless-stopped

  # --------------------------------------------------------------------------
  # Production: SSE transport, OAuth enabled, locked-down
  # --------------------------------------------------------------------------
  prod:
    build:
      context: .
      dockerfile: Dockerfile
    profiles: ["prod"]
    ports:
      - "8000:8000"
    volumes:
      - bamcp-data:/data:ro
    environment:
      - BAMCP_REFERENCE=/data/reference.fa
      - BAMCP_MAX_READS=10000
      - BAMCP_DEFAULT_WINDOW=500
      - BAMCP_MIN_VAF=0.1
      - BAMCP_MIN_DEPTH=10
      - BAMCP_MIN_MAPQ=0
      - BAMCP_TRANSPORT=sse
      - BAMCP_HOST=0.0.0.0
      - BAMCP_PORT=8000
      - BAMCP_AUTH_ENABLED=true
      - BAMCP_ISSUER_URL=http://localhost:8000
      - BAMCP_RESOURCE_SERVER_URL=http://localhost:8000
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=64m
    security_opt:
      - no-new-privileges:true
    restart: always

volumes:
  bamcp-data:
    driver: local
